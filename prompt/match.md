# MATCH Step + 신규 Step(EXPRESSION) 요구사항 정리

## 0. 목적

- UPLOAD에서 업로드한 **베이스 이미지** 위에 최대 5명의 “사람 마커(원형 버튼)”를 올리고,
- 각 사람별로 **얼굴 사진 업로드/교체** 및 **마커 위치/변형(이동/확대/회전)**을 설정한다.
- 표정 선택 기능은 MATCH에서 분리하여 **다음 FSM Step(가칭 EXPRESSION)**에서 처리한다.
- 다음 Step에서 **뒤로가기 시 MATCH에서 편집/선택하던 상태가 그대로 유지**되어야 한다.

---

## 1. FSM 변경 요구사항

### 1.1 Step 추가

- FSM Step을 1개 추가한다.
- 추천 이름(예): `EXPRESSION` (표정 선택 전용 Step)

### 1.2 전이(Transition) 규칙

- `UPLOAD → MATCH → EXPRESSION → VERIFY(또는 기존 다음 단계)`
- `EXPRESSION`에서 뒤로가기(`prevStep`) 시 `MATCH`로 이동한다.
- `EXPRESSION`에서 뒤로가기 시, **MATCH에서 선택되었던 상태가 그대로 유지**되어야 한다.

### 1.3 상태 유지 원칙

- MATCH/EXPRESSION에서 사용하는 데이터는 컴포넌트 로컬 state가 아니라 **전역 store(entities)**에 저장한다.
- MATCH 페이지 진입 시 “기본값 시드/초기화”는 **UPLOAD 직후 최초 1회만** 수행한다.
    - EXPRESSION에서 뒤로 돌아오는 경우 MATCH의 상태가 리셋되면 안 된다.

---

## 2. MATCH Step UI/UX 요구사항

### 2.1 화면 구성

- 페이지 진입 시 UPLOAD Step에서 업로드한 **베이스 이미지가 표시**된다.
- 이미지 아래에 **하단 설정란(사람 목록)**이 존재한다.
- 하단 설정란에:
    - “사람 원형 버튼(유저 아이콘/썸네일)”들이 나열된다.
    - “+ 아이콘 원형 버튼”이 존재한다.

### 2.2 사람 버튼(+ / 삭제 / 최소/최대)

- `+` 클릭 시 사람 버튼이 추가되며 **최대 5개**까지 생성 가능.
- 사람 버튼은 **최소 1개 이상 유지**되어야 하며, 1개일 때 삭제는 불가(비활성/숨김/차단 처리 중 택1).
- 각 사람 버튼 우측 상단에 **X(삭제) 버튼**이 존재한다.
    - 모바일에서도 X 버튼 터치가 어렵지 않도록 **충분한 터치 영역**을 보장해야 한다.
- 삭제 시 해당 사람에 연결된 데이터(업로드 얼굴 사진/변형 데이터 등)도 함께 제거된다.

### 2.3 사람 색상 규칙(중요: 랜덤 아님)

- 사람 버튼/마커 색상은 **고정 순서로 배정**한다(랜덤 배정 제거).
- 색상 순서: **파란색 → 보라색 → 빨간색 → 노란색 → 초록색**
- 사람 추가 시:
    - 위 순서에서 **아직 사용되지 않은 첫 번째 색상**을 할당한다.
- 사람 삭제 시:
    - 해당 색상은 “반납”되며, 이후 추가 시 **순서 기준으로 가장 앞의 빈 색상부터 재사용**한다.
- 이미 생성된 사람의 색상은 삭제/추가로 인해 **자동으로 재배치(변경)되지 않는다**.

### 2.4 얼굴 사진 업로드/교체 규칙(중요: 항상 업로드)

- 사람 버튼(하단 설정란) 클릭 시:
    - **사진 유무와 상관없이 항상 업로드/교체 동작**을 수행한다(항상 파일 선택창 오픈).
> 참고: 이 규칙 때문에 “선택(Active 변경)”이 클릭과 충돌할 수 있으므로, 선택 UX는 별도 규칙으로 구현한다(아래 2.5).
> 

### 2.5 사람 선택(Active) 규칙

- “업로드/교체”와 “선택 변경”이 충돌하지 않도록 선택은 다음 방식 중 하나로 제공해야 한다(필수):
    - (권장) 하단 설정란에서 **사람 항목의 별도 영역(카드/테두리/라벨 영역)** 클릭으로 Active 변경, 원형 버튼 클릭은 업로드 전용
    - (대안) 업로드 완료 시 해당 사람을 자동으로 Active로 설정하고, Active 변경은 “다른 UI(예: 라디오/선택 버튼)”로 제공
- 어떤 방식을 택하든, Active 상태(현재 편집 중인 사람)는 전역 store에 저장해야 한다.

---

## 3. 이미지 오버레이(마커) 동기화 요구사항

### 3.1 동기화 원칙

- 하단 설정란의 사람 목록과 이미지 위 오버레이 마커는 **항상 1:1로 동기화**된다.
- 하단에서 사람 추가/삭제/사진 업로드/교체 시:
    - 이미지 위 마커도 동일하게 추가/삭제/썸네일 반영이 되어야 한다.
- 이미지 위 마커에서 사진 업로드/교체를 수행해도:
    - 하단 설정란의 동일 사람 버튼에도 동일하게 반영되어야 한다.

### 3.2 초기 배치

- 베이스 이미지의 **좌측 하단 근처**에 사람 마커가 기본 배치된다(초기 위치는 구현에서 합리적으로 설정).
- 하단 설정란에서 사람을 추가하면 이미지 내에도 해당 마커가 추가된다.

---

## 4. 마커 편집 기능 요구사항(MATCH 범위)

### 4.1 이동(Drag)

- 이미지 내 마커는
    - 데스크탑: 마우스 드래그
    - 모바일: 터치 드래그
        
        로 위치를 이동할 수 있어야 한다.
        

### 4.2 확대/축소(Scale)

- 이미지 내 마커는 확대/축소를 지원해야 한다.
- 모바일: 핀치 제스처 기반 확대/축소를 지원한다(권장).
- 데스크탑: 구현 방식은 자유(핸들/슬라이더/단축키 등)이나 기능은 제공되어야 한다.

### 4.3 회전(Rotate)

- 이미지 내 마커는 회전을 지원해야 한다.
- 모바일: 두 손가락 회전 제스처 지원(권장).
- 데스크탑: 구현 방식은 자유(회전 핸들/슬라이더 등)이나 기능은 제공되어야 한다.

### 4.4 저장 데이터

- 마커의 편집 결과는 사람별로 저장한다:
    - 위치(x, y), 스케일, 회전값
- 좌표는 화면 크기 변동에 강하도록 **정규화 좌표(0~1)** 저장을 권장한다.

---

## 5. EXPRESSION Step 범위(신규 Step)

- MATCH에서 표정 선택 UI는 제거한다.
- 표정 선택 기능은 신규 Step(EXPRESSION)에서 제공한다.
- EXPRESSION에서 뒤로가기 시 MATCH로 돌아가며,
    - MATCH의 사람 목록/업로드된 얼굴 사진/마커 위치/스케일/회전/현재 Active 사람 상태가 **그대로 유지**되어야 한다.

---

## 6. 비기능 요구사항

- 모바일 조작성(특히 X 버튼) 문제 없도록 충분한 hit area 제공
- 상태는 전역 store로 유지(언마운트/스텝 이동에도 보존)
- MATCH 재진입 시 초기화로 인해 데이터가 리셋되지 않도록 “최초 1회 초기화” 가드 필요
---
1. 생성된 기능 중 몇가지 문제가 있습니다. 이를 해결해주세요.
- 이미지 오버레이 마커의 회전 버튼은 표시되나 버튼을 드래그했을 때 작동하지 않습니다. 
- 이미지 오버레이 마커의 확대/축소 버튼이 표시되어 확장하는데 확장 버튼을 클릭한채로 안쪽으로 좁혔을 때 커지고 밖으로 확장했을 때 작아집니다. (반대로 동작하는 문제) 이 동작이 반대로 되는 문제를 수정해주세요.
- 이미지 오버레이 마커의 최대 확대 제한을 지금 상태에서 1.5배 늘려주세요.
- 이미지 오버레이 마커를 클릭했을 때 이미지가 업로드 되어선 안됩니다. 이미지 업로드는 인물 설정 영역의 사람 버튼을 클릭했을 때만 가능합니다.
- 이미지 오버레이 마커를 클릭하면 해당 이미지 오버레이 마커는 확대/축소와 같은 수정 가능한 상태가 되며, 회전 버튼, 확대/축소 버튼 등이 표시됩니다. 다른 이미지 오버레이 마커를 클릭하면 이전에 클릭했던 이미지 오버레이 마커는 수정 가능한 상태가 해제됩니다.
- 현재 인물 설정의 1/5는 꼭 5명을 다 채워야할 것 같습니다. 별도의 안내 문구나 UI가 필요할 것 같습니다.
- 인물 설정 초기화 버튼이 필요합니다. 클릭시 기존에 배치한 인물 설정이 초기화되어야 합니다. (처음 MATCH Step에 도착했을 상태로 돌아갑니다.)
2. 변경 사항 확인 중 문제를 발견했습니다.
- 초기화 버튼을 클릭시 업로드 버튼이 우측에 있다가 왼쪽으로 이동하며 제자리를 찾아가는 애니메이션이 발생하는데 이를 제거해주세요. (부자연스러움), 추가로 인물을 추가한 다음에 안쪽의 인물을 제거하는 경우에도 인물 설정 내 버튼이 왼쪽으로 버벅이며 이동하는 애니메이션이 발생합니다. 이를 제거해주세요.
- 여전히 회전 기능은 동작하지 않습니다. 개선해주세요.
- 이미지가 업로드된 이미지 오버레이 마커 내의 이미지 위치를 수정하고 싶은 경우에 해당 하는 기능을 제공하고 싶습니다. 예를 들어 이미지를 업로드했을 때 이미지에 제 얼굴이 위치하지 않아 이미지 위치를 조정해 얼굴이 가운데로 오게 하고 싶을 수 있잖아요? 이때의 기능을 만들고 싶습니다.
3. 이 단계에서 설정한 모든 상태(원 별 이미지, 크기, 사진 조정 등)을 상태로 저장해야 합니다. 이는 추후 이미지 생성 AI에게 프롬프트로 전달될 예정입니다. 그에 따라 정~말 자세하게 전달해야 할 합니다.
4. 현재 개발한 내용들 대해 ./ruler 폴더의 개발 문서들을 업데이트 해주세요. (PRD에도 변경사항을 반영해주세요.)
5. 컴포넌트 및 hook이 개발됐으나 테스트 코드 작성 및 storybook 작성은 하지 않았습니다. 테스트 코드 작성 및 storybook을 반드시 작성하라고 ./ruler/AGENTS.md에 규칙을 만들어주세요.
6. MATCH Step 단계에서 인물을 배치한 다음 이전으로 돌아가기 버튼 클릭시 인물 설정이나 배치 같은 것들이 초기화되어야 합니다. 이를 위해 StepHeader에 뒤로가기 버튼 클릭시 함께 실행될 함수를 전달 받을 수 있는 props를 추가하고 여기에서 초기화 함수를 실행하도록 수정해주세요.
7. 인물 설정에서 인물을 추가했을 때 이미지 오버레이에 마커 배치 간격이 좀 더 좁아야 합니다. 예를 들어 처음 페이지에 왔을 때 파란색 마커가 좌측 하단에 배치된 상태입니다. 이때 인물을 추가하면 보라색 이미지 오버레이 마커가 파란색 마커의 위로 반쯤 겹쳐서 배치됐으면 합니다.
8. 이미지가 업로드된 이미지 오버레이 마커 내의 이미지 크기를 수정하는 기능을 제공하고 싶습니다. 예를 들어 이미지를 업로드 했을 때 이미지가 생각보다 너무 클 경우 작게 줄여서 보고 싶다거나 너무 작게 보일 경우 크게 늘려서 보고 싶을 때 사용합니다. 이 데이터도 다른 데이터와 마찬가지로 상태로 저장되어야 합니다.